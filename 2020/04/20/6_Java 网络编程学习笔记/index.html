<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前置概念Java IO 模型   IO 模型 对应的 Java 版本     BIO（同步阻塞 IO） 1.4 之前   NIO（同步非阻塞 IO） 1.4   AIO（异步非阻塞 IO） 1.7">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 网络编程学习笔记">
<meta property="og:url" content="http://yoursite.com/2020/04/20/6_Java 网络编程学习笔记/index.html">
<meta property="og:site_name" content="Nowhere">
<meta property="og:description" content="前置概念Java IO 模型   IO 模型 对应的 Java 版本     BIO（同步阻塞 IO） 1.4 之前   NIO（同步非阻塞 IO） 1.4   AIO（异步非阻塞 IO） 1.7">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://img2018.cnblogs.com/blog/1748170/201909/1748170-20190906210650873-272348693.png">
<meta property="og:image" content="http://assets.processon.com/chart_image/5edb0f207d9c0866361b02d2.png">
<meta property="og:updated_time" content="2020-10-31T04:16:09.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 网络编程学习笔记">
<meta name="twitter:description" content="前置概念Java IO 模型   IO 模型 对应的 Java 版本     BIO（同步阻塞 IO） 1.4 之前   NIO（同步非阻塞 IO） 1.4   AIO（异步非阻塞 IO） 1.7">
<meta name="twitter:image" content="https://img2018.cnblogs.com/blog/1748170/201909/1748170-20190906210650873-272348693.png">





  
  
  <link rel="canonical" href="http://yoursite.com/2020/04/20/6_Java 网络编程学习笔记/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Java 网络编程学习笔记 | Nowhere</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nowhere</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/20/6_Java 网络编程学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="stone">
      <meta itemprop="description" content="Hungry Fool">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nowhere">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java 网络编程学习笔记

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-04-20 10:12:47" itemprop="dateCreated datePublished" datetime="2020-04-20T10:12:47+08:00">2020-04-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-10-31 12:16:09" itemprop="dateModified" datetime="2020-10-31T12:16:09+08:00">2020-10-31</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/面试/" itemprop="url" rel="index"><span itemprop="name">面试</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2020/04/20/6_Java 网络编程学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/04/20/6_Java 网络编程学习笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前置概念"><a href="#前置概念" class="headerlink" title="前置概念"></a>前置概念</h2><h3 id="Java-IO-模型"><a href="#Java-IO-模型" class="headerlink" title="Java IO 模型"></a><strong>Java IO 模型</strong></h3><table>
<thead>
<tr>
<th>IO 模型</th>
<th>对应的 Java 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>BIO（同步阻塞 IO）</td>
<td>1.4 之前</td>
</tr>
<tr>
<td>NIO（同步非阻塞 IO）</td>
<td>1.4</td>
</tr>
<tr>
<td>AIO（异步非阻塞 IO）</td>
<td>1.7</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<hr>
<h3 id="Linux-内核-IO-模型"><a href="#Linux-内核-IO-模型" class="headerlink" title="Linux 内核 IO 模型"></a>Linux 内核 IO 模型</h3><ul>
<li><p><strong>阻塞 IO</strong></p>
<p>最传统的一种 IO 模型，在读写数据过程中会发生阻塞。</p>
<p>当用户线程发出 IO 请求后，内核会去查看数据是否就绪，如果没有就绪就会等待数据就绪，而用户线程就会处于阻塞状态，用户线程交出CPU。当数据就绪之后，内核会将数据拷贝到用户线程，并返回 IO 执行结果给用户线程，用户线程解除阻塞状态并开始处理数据。</p>
<p>对应于 Java 中的 BIO。</p>
</li>
<li><p><strong>非阻塞 IO</strong></p>
<p>当用户线程发起 IO 请求后并不需要等待，即使内核数据还没有准备好也会马上得到内核返回的一个结果，用户线程可以之后再次询问内核。一旦内核中的数据准备好了，并且又再次收到了用户线程的请求，那么内核就将数据拷贝到用户线程并通知用户线程。</p>
<p>在非阻塞 IO 中，用户线程需要不断询问内核数据是否准备就绪，在数据未就绪时可以处理其他任务。</p>
</li>
<li><p><strong>多路复用 IO</strong></p>
<p>在多路复用 IO 模型中会有一个 Selector 线程不断轮询多个 Socket 的状态，只有当 Socket 真正有读写事件时才通知用户线程进行实际的 IO 读写操作。阻塞 IO 和 非阻塞 IO 模型需要为每个 Socket 建立一个单独的线程处理数据，而多路复用 IO 只需要一个线程管理多个 Socket，并且只在真正有读写事件时才会使用操作系统的 IO 资源，大大节约了系统资源。</p>
<p>在非阻塞 IO 中不断询问 Socket 状态是通过用户线程进行的，而在多路复用 IO 中轮询每个 Socket 状态是内核在进行的，效率要比用户线程高。</p>
<p>对于多路复用 IO 模型来说在事件响应体很大时，Selector 线程会成为性能瓶颈，导致后续事件无法及时处理，影响下一轮事件轮询，因此实际应用中方法体内不做复杂逻辑处理，只做数据的接收和转发，而将具体业务操作转发给业务线程处理。</p>
<p>对应于 Java 中的 NIO，在 NIO 中通过 <code>selector.select()</code> 去查询每个 Channel 是否有事件到达，如果没有事件到达用户线程会一直阻塞，因此 NIO 也会导致用户线程的阻塞。</p>
</li>
<li><p><strong>信号驱动 IO</strong></p>
<p>当用户线程发起一个 IO 请求操作，会给对应的 Socket 注册一个信号函数，然后用户线程会继续执行，当内核数据就绪时会发送一个信号给用户线程，用户线程接收到信号之后，便在信号函数中调用 IO 读写操作来进行实际的 IO 请求操作。</p>
<p>一般用于 UDP 中。</p>
</li>
<li><p><strong>异步 IO</strong></p>
<p>当用户线程发起异步 read 操作后，立刻就可以开始去做其它事。另一方面，从内核的角度，当它收到一个异步 read 之后会立刻返回一个状态，说明请求是否成功发起，用户线程不会任何阻塞。然后内核会等待数据准备完成并将数据拷贝到用户线程，完成后内核会给用户线程发送一个信号通知 read 操作已完成。</p>
<p>用户线程完全不需要关心实际的整个 IO 操作是如何进行的，只需要先发起一个请求，当接收内核返回的成功信号时表示 IO 操作已经完成，就可以直接去使用数据了。</p>
<p>在异步IO模型中，IO操作的两个阶段都不会阻塞用户线程，这两个阶段都是由内核自动完成，然后发送一个信号告知用户线程操作已完成，用户线程<strong>不需要再次调用 IO 函数进行具体的读写</strong>。在信号驱动模型中，当用户线程接收到信号表示数据已经就绪，然后需要用户线程调用IO函数进行实际的读写操作。</p>
<p>对应于 Java 中的 AIO。    </p>
</li>
</ul>
<p><img src="https://img2018.cnblogs.com/blog/1748170/201909/1748170-20190906210650873-272348693.png" style="zoom:80%;"></p>
<hr>
<h3 id="URL-解析与构造"><a href="#URL-解析与构造" class="headerlink" title="URL 解析与构造"></a>URL 解析与构造</h3><p>当在浏览器输入： <code>http://www.google.com</code> 时,</p>
<p>可能发出的实际请求是： <code>http://www.google.com:80/search?q=test&amp;safe=strict</code></p>
<p>其中 <code>http</code> 表示应用协议，<code>www.google.com</code> 表示域名，<code>80</code> 表示端口（可以明确指定要进行数据交换的进程），<code>search</code> 表示路径（请求提供的服务），<code>q=test&amp;safe=strict</code> 表示请求参数。</p>
<p>其中域名通过 DNS 域名解析系统将域名解析为主机的 IP 地址，解析时是从右向左解析的，<code>www.google.com</code> 实际上是<code>www.google.com.root</code>，<code>.root</code> 是根域名，一般会省略。</p>
<p>域名的层级如下：</p>
<table>
<thead>
<tr>
<th>域名层级</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>根域名</td>
<td><code>.root</code></td>
</tr>
<tr>
<td>顶级域名</td>
<td><code>.com</code>、  <code>.edu</code> 、  <code>.org</code></td>
</tr>
<tr>
<td>次级域名</td>
<td><code>.google</code>  、 <code>.baidu</code> 、  <code>.qq</code></td>
</tr>
<tr>
<td>主机名</td>
<td><code>www</code></td>
</tr>
</tbody>
</table>
<p>DNS 本质是一个分布式数据库，域名对应 IP 地址的映射关系存储在不同层级的域名服务器上，查询方式分为递归查询和迭代查询。</p>
<p><strong>递归查询：</strong>浏览器将域名发给 DNS 客户端，DNS 客户端将查询请求发送给根域名服务器，根域名服务器如果知道对应 IP 地址将返回结果，否则发送给其已知的顶级域名服务器查询，顶级域名如果知道对应的 IP 地址就返回结果，否则就发给其已知的二级域名服务器查询，二级域名服务器也进行类似操作，最终将结果一路返回给浏览器。</p>
<p><strong>迭代查询：</strong>DNS 客户端将请求发送给根域名服务器，如果根域名服务器不知道对应 IP 地址不会去请求顶级域名服务器，而是把已知的顶级域名服务器返回给 DNS 客户端（不会帮 DNS 客户端去查询），DNS 客户端得到顶级域名服务器地址后就再去请求顶级域名服务器发送查询请求，以此类推。</p>
<p>不管使用哪种方式，一旦查询成功，都会将结果缓存在查询经过的域名服务器、DNS 客户端或浏览器上。根域名服务器很少，一般其地址都内置在 DNS 客户端中。</p>
<hr>
<h3 id="网络分层"><a href="#网络分层" class="headerlink" title="网络分层"></a>网络分层</h3><table>
<thead>
<tr>
<th>网络分层</th>
<th>数据格式</th>
<th>协议</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>报文</td>
<td>HTTP、FTP、SMTP</td>
<td>通过应用进程之间的交互来完成特定网络应用。</td>
</tr>
<tr>
<td>运输层</td>
<td>报文段/用户数据报</td>
<td>TCP、UDP</td>
<td>向两台主机进程之间的通信提供的数据传输服务。</td>
</tr>
<tr>
<td>网络层</td>
<td>分组/包</td>
<td>IP、ICMP、IGMP、ARP</td>
<td>为分组交换网上的不同主机提供通信服务。</td>
</tr>
<tr>
<td>数据链路层</td>
<td>帧</td>
<td>PPP、CSMA/CD</td>
<td>将网络层 IP 数据报组装成帧，在两个相邻结点之间的链路上传输。</td>
</tr>
<tr>
<td>物理层</td>
<td>0、1电信号</td>
<td>FDDI</td>
<td>屏蔽掉传输媒体和通信手段的差异。</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="java-io"><a href="#java-io" class="headerlink" title="java.io"></a>java.io</h3><p>网络编程的本质是进程间的通信，通信的基础是 IO 模型</p>
<p>IO 流分类：</p>
<p><img src="http://assets.processon.com/chart_image/5edb0f207d9c0866361b02d2.png" style="zoom:40%;" align="left"></p>
<p>java.io 包中用到了装饰器模式：</p>
<p>例如创建 BufferedInputStream 对象时必须传入一个 InputStream 对象（如 FileInputStream 对象）作为参数，可以利用缓冲区在内存读写数据提高效率。</p>
<hr>
<h3 id="Socket-概述"><a href="#Socket-概述" class="headerlink" title="Socket 概述"></a>Socket 概述</h3><p>Socket 也是一种数据源，是网络通信的端点，可以把 Socket 理解为一个唯一的 IP 地址和端口号，例如 <code>127.0.0.1:8080</code>。</p>
<p>发送数据：</p>
<p>应用进程创建 Socket 并绑定到网卡的驱动程序，通过 Socket 发送数据，网卡驱动程序从 Socket 读取数据并发送。</p>
<p>接收数据：</p>
<p>应用进程创建 Socket 并绑定到网卡的驱动程序，网卡驱动程序从网络中接收到数据并传输给 Socket，Socket 将数据再传输给应用进程。</p>
<hr>
<h3 id="同步-异步-阻塞-非阻塞"><a href="#同步-异步-阻塞-非阻塞" class="headerlink" title="同步/异步/阻塞/非阻塞"></a>同步/异步/阻塞/非阻塞</h3><p>同步和异步是通信机制，阻塞和非阻塞是调用状态。</p>
<ul>
<li><p>同步 IO 是用户线程发起 I/O 请求后需要等待或者轮询内核 I/O 操作完成后才能继续执行。</p>
</li>
<li><p>异步 IO 是用户线程发起 I/O 请求后仍可以继续执行，当内核 I/O 操作完成后会通知用户线程，或者调用用户线程注册的回调函数。</p>
</li>
<li><p>阻塞 IO 是指 I/O 操作需要彻底完成后才能返回用户空间 。</p>
</li>
<li>非阻塞 IO 是指 I/O 操作被调用后立即返回一个状态值，无需等 I/O 操作彻底完成。</li>
</ul>
<hr>
<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><p>线程池可以通过复用线程，减小线程创建和销毁的开销，提高程序效率。Executors 类提供了几种静态方法直接创建线程池：</p>
<ul>
<li><p>newSingleThreadExecutor </p>
<p>线程池中只有一个线程，不断复用</p>
</li>
<li><p>newFixedThreadPool</p>
<p>线程池中的线程数量是固定的</p>
</li>
<li><p>newCachedThreadPool</p>
<p>提交的任务如果有空闲线程则处理，否则创建一个新线程来处理任务</p>
</li>
<li><p>newScheduledThreadPool</p>
<p>提交的任务可以在指定的时间执行</p>
</li>
</ul>
<hr>
<h2 id="BIO-同步阻塞"><a href="#BIO-同步阻塞" class="headerlink" title="BIO 同步阻塞"></a>BIO 同步阻塞</h2><p>BIO 即同步阻塞式 IO，每一个客户端请求都对应一个线程来处理。</p>
<p>服务器端通常由一个独立的 Acceptor 线程负责监听客户端的连接。一般通过在 <code>while(true)</code> 循环中调用 <code>accept()</code> 方法接收客户端连接的方式监听连接请求，请求一旦接收到一个连接请求，就可以建立通信套接字在这个通信套接字上进行读写操作，此时不能再接收其他客户端连接请求，只能等待同当前连接的客户端的操作执行完成， 可以通过多线程来支持多个客户端的连接。</p>
<h3 id="模拟-TCP-通信"><a href="#模拟-TCP-通信" class="headerlink" title="模拟 TCP 通信"></a>模拟 TCP 通信</h3><p>Socket类 是客户端的 Socket 连接，使用步骤：</p>
<ul>
<li>创建对象时要提供服务器的主机和端口参数。</li>
<li>数据通信结束后通过 close 方法关闭连接。</li>
</ul>
<p>ServerSocket 类是服务器端的 Socket 连接，使用步骤：</p>
<ul>
<li><p>创建对象时要提供端口参数进行绑定，服务器会监听该端口，任何发送到该端口的信息都会被服务器接收并处理。</p>
</li>
<li><p>通过 accept 方法获取客户端连接，通过该连接与客户端进行数据通信，是一种<strong>阻塞式</strong>调用。</p>
</li>
</ul>
<hr>
<p>服务器的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 退出条件</span></span><br><span class="line">        <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line">        <span class="comment">// 服务器端口</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">8080</span>;</span><br><span class="line">        <span class="comment">// 服务器的 socket 对象</span></span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 绑定监听端口</span></span><br><span class="line">            serverSocket = <span class="keyword">new</span> ServerSocket(PORT);</span><br><span class="line">            System.out.println(<span class="string">"启动服务器，监听端口："</span> + PORT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="comment">// 等待客户端连接</span></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                System.out.println(<span class="string">"客户端["</span> + socket.getPort() + <span class="string">"]已连接"</span>);</span><br><span class="line">                <span class="comment">// 获取和客户端通信的字符输入流和字符输出流</span></span><br><span class="line">                BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">                BufferedWriter bw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取客户端发送的消息</span></span><br><span class="line">                String message;</span><br><span class="line">                <span class="keyword">while</span> ((message = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"客户端["</span> + socket.getPort() + <span class="string">"]发送消息："</span> + message);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 回复客户端</span></span><br><span class="line">                    bw.write(<span class="string">"服务器已经收到消息："</span> + message + <span class="string">"\n"</span>);</span><br><span class="line">                    bw.flush();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 查看客户端是否关闭</span></span><br><span class="line">                    <span class="keyword">if</span> (QUIT.equals(message))&#123;</span><br><span class="line">                        System.out.println(<span class="string">"客户端["</span> + socket.getPort() + <span class="string">"]已断开连接"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放资源</span></span><br><span class="line">            <span class="keyword">if</span>(serverSocket != <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    serverSocket.close();</span><br><span class="line">                    System.out.println(<span class="string">"关闭 serverSocket"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>客户端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 退出条件</span></span><br><span class="line">        <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line">        <span class="comment">// 服务器主机和端口</span></span><br><span class="line">        <span class="keyword">final</span> String HOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">8080</span>;</span><br><span class="line">        <span class="comment">// 客户端的 socket 对象</span></span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        BufferedWriter bw = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 socket</span></span><br><span class="line">            socket = <span class="keyword">new</span> Socket(HOST, PORT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取和服务器通信的字符输入流和字符输出流</span></span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">            bw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 等待用户输入信息</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"请输入要发送的消息："</span>);</span><br><span class="line">                BufferedReader consoleReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">                String input = consoleReader.readLine();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发送消息给服务器</span></span><br><span class="line">                bw.write(input + <span class="string">"\n"</span>);</span><br><span class="line">                bw.flush();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 读取服务器返回的消息</span></span><br><span class="line">                String message= br.readLine();</span><br><span class="line">                <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"服务器发送消息："</span> + message);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查看用户是否退出</span></span><br><span class="line">                <span class="keyword">if</span>(QUIT.equals(input))&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放资源</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(bw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bw.close();</span><br><span class="line">                    System.out.println(<span class="string">"关闭 socket"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="基于-BIO-的多人聊天室"><a href="#基于-BIO-的多人聊天室" class="headerlink" title="基于 BIO 的多人聊天室"></a>基于 BIO 的多人聊天室</h3><ul>
<li>基于 BIO 模型</li>
<li>支持多人同时在线</li>
<li>每个用户的发言都会被转发给其他在线用户</li>
</ul>
<p>一共由四个类组成：</p>
<ul>
<li><p>服务器类：ChatServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 结束条件 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/** 服务器端的 socket 连接 */</span></span><br><span class="line">    <span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/** 存储在线用户 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Writer&gt; clients;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        clients = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加在线用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> socket 上线的客户端 socket 连接对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 可能产生的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addClient</span><span class="params">(Socket socket)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> port = socket.getPort();</span><br><span class="line">            BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</span><br><span class="line">            clients.put(port, writer);</span><br><span class="line">            System.out.println(<span class="string">"客户端["</span> + port + <span class="string">"]已连接到服务器"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除离线用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> socket 下线的客户端 socket 连接对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 可能产生的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(Socket socket)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(socket != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> port = socket.getPort();</span><br><span class="line">            <span class="comment">// 如果当前用户仍在在线用户集合中则移除</span></span><br><span class="line">            <span class="keyword">if</span>(clients.containsKey(port))&#123;</span><br><span class="line">                clients.get(port).close();</span><br><span class="line">            &#125;</span><br><span class="line">            clients.remove(port);</span><br><span class="line">            System.out.println(<span class="string">"客户端["</span> + port + <span class="string">"]已断开连接"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转发消息给其他用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> socket 要发送消息的客户端的 socket 连接对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 要发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 可能产生的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">forwardMessage</span><span class="params">(Socket socket, String message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer port : clients.keySet())&#123;</span><br><span class="line">            <span class="comment">// 遍历在线用户，通过比较端口号判断当前用户是否是发送消息的用户，如果不是则转发消息</span></span><br><span class="line">            <span class="keyword">if</span>(!port.equals(socket.getPort()))&#123;</span><br><span class="line">                Writer writer = clients.get(port);</span><br><span class="line">                writer.write(message);</span><br><span class="line">                writer.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看用户是否准备退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示准备退出，反之</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span> <span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QUIT.equals(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(serverSocket != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                serverSocket.close();</span><br><span class="line">                System.out.println(<span class="string">"关闭 serverSocket"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动服务器端开始监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 绑定监听端口</span></span><br><span class="line">            serverSocket = <span class="keyword">new</span> ServerSocket(PORT);</span><br><span class="line">            System.out.println(<span class="string">"服务器已经启动，监听端口："</span> + PORT);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 等待获取客户端连接</span></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                <span class="comment">// 创建线程处理客户端连接</span></span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> ChatHandler(<span class="keyword">this</span>, socket)).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放资源</span></span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用 main 线程模拟 Acceptor 线程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args main方法参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ChatServer chatServer = <span class="keyword">new</span> ChatServer();</span><br><span class="line">        <span class="comment">// 启动服务器</span></span><br><span class="line">        chatServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器处理客户端连接类：ChatHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务端 */</span></span><br><span class="line">    <span class="keyword">private</span> ChatServer chatServer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 客户端连接 */</span></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatHandler</span><span class="params">(ChatServer chatServer, Socket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.chatServer = chatServer;</span><br><span class="line">        <span class="keyword">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理客户端连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 添加新上线用户</span></span><br><span class="line">            chatServer.addClient(socket);</span><br><span class="line">            <span class="comment">// 读取用户发送的信息</span></span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">            String message;</span><br><span class="line">            <span class="keyword">while</span> ((message = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String forwardMessage = <span class="string">"客户端["</span> + socket.getPort() + <span class="string">"]发送了一条消息："</span> + message + <span class="string">"\n"</span>;</span><br><span class="line">                System.out.println(forwardMessage);</span><br><span class="line">                <span class="comment">// 转发消息给其他在线用户</span></span><br><span class="line">                chatServer.forwardMessage(socket, forwardMessage);</span><br><span class="line">                <span class="comment">// 查看用户是否准备退出</span></span><br><span class="line">                <span class="keyword">if</span>(chatServer.checkQuit(message))&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 移除离线用户</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                chatServer.removeClient(socket);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端类：ChatClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器主机 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String HOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 结束条件 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 和服务器通信的 socket */</span></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 和服务器通信的输入流 */</span></span><br><span class="line">    <span class="keyword">private</span> BufferedReader reader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 和服务器通信的输出流 */</span></span><br><span class="line">    <span class="keyword">private</span> BufferedWriter writer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送信息给服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 要发送的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 可能抛出的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 确保输出流是开放状态</span></span><br><span class="line">        <span class="keyword">if</span>(!socket.isOutputShutdown())&#123;</span><br><span class="line">            writer.write(message + <span class="string">"\n"</span>);</span><br><span class="line">            writer.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从服务器端接收消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回接受的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 可能抛出的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">receive</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String message = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 确保输入流是开放状态</span></span><br><span class="line">        <span class="keyword">if</span>(!socket.isInputShutdown())&#123;</span><br><span class="line">            message = reader.readLine();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看用户是否准备退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示准备退出，反之</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span> <span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QUIT.equals(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(writer != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                writer.close();</span><br><span class="line">                System.out.println(<span class="string">"关闭 socket"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 socket</span></span><br><span class="line">            socket = <span class="keyword">new</span> Socket(HOST, PORT);</span><br><span class="line">            <span class="comment">// 创建 IO 流</span></span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">            writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</span><br><span class="line">            <span class="comment">// 创建新线程处理用户的输入</span></span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> UserInputHandler(<span class="keyword">this</span>)).start();</span><br><span class="line">            <span class="comment">// 读取服务器转发的消息</span></span><br><span class="line">            String message;</span><br><span class="line">            <span class="keyword">while</span> ((message = receive()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                System.out.println(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放资源</span></span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ChatClient chatClient = <span class="keyword">new</span> ChatClient();</span><br><span class="line">        <span class="comment">// 启动客户端</span></span><br><span class="line">        chatClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端处理用户输入类：UserInputHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInputHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 客户端 */</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInputHandler</span><span class="params">(ChatClient chatClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.chatClient = chatClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理用户输入信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 等待用户输入信息</span></span><br><span class="line">            BufferedReader consoleReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                String message = consoleReader.readLine();</span><br><span class="line">                <span class="comment">// 向服务器发送消息</span></span><br><span class="line">                chatClient.send(message);</span><br><span class="line">                <span class="comment">// 检查用户是否准备退出</span></span><br><span class="line">                <span class="keyword">if</span>(chatClient.checkQuit(message))&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="伪异步-IO-改进多人聊天室"><a href="#伪异步-IO-改进多人聊天室" class="headerlink" title="伪异步 IO 改进多人聊天室"></a>伪异步 IO 改进多人聊天室</h3><p>在基于 BIO 的多人聊天室中，一个客户端请求对应着一个线程，当用户数量很大时线程的开销也会很大。我们可以通过线程池来实现伪异步 IO 来进行优化，限制线程的总数量，实现线程的复用。</p>
<p>在 ChatServer 中添加属性并修改构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 线程池 */</span></span><br><span class="line"><span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 限制服务器处理请求的线程数为 10</span></span><br><span class="line">    executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    clients = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时修改 ChatServer 的 start 方法中创建线程部分的代码，改为使用线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 等待获取客户端连接</span></span><br><span class="line">    Socket socket = serverSocket.accept();</span><br><span class="line">    <span class="comment">// 将处理请求任务提交给线程池执行</span></span><br><span class="line">    executorService.execute(<span class="keyword">new</span> ChatHandler(<span class="keyword">this</span>, socket));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="NIO-同步非阻塞"><a href="#NIO-同步非阻塞" class="headerlink" title="NIO 同步非阻塞"></a>NIO 同步非阻塞</h2><p>BIO 中的阻塞：</p>
<ul>
<li>ServerSocket 的 accept()</li>
<li>InputStream 和 OutputStream 的读和写</li>
<li>无法在同一个线程中处理多个 Stream IO</li>
</ul>
<p>可以使用非阻塞的 IO 即 NIO，在 NIO 中：</p>
<ul>
<li>使用 Channel 代替 Stream，Channel 是双向的，既可以读数据也可以写数据，既可以阻塞读写也可以非阻塞读写</li>
<li>使用 Selector 监控多条 Channel</li>
<li>可以在一个线程里处理多个 Channel IO</li>
</ul>
<hr>
<p><strong>NIO 的核心组件：</strong></p>
<ul>
<li><p><strong>Selector</strong></p>
<p>选择器或多路复用器，主要作用是轮询检查多个 Channel 的状态，判断 Channel 注册的事件是否发生，即判断 Channel 是否处于可读或可写状态。</p>
<p>在使用之前需要将 Channel 注册到 Selector 上，注册之后会得到一个 SelectionKey。</p>
<p>SelectionKey 的相关方法：</p>
<ul>
<li>interestOps() ： 查看 Channel 对象注册的状态集合，例如 Accept（接收到一个客户端请求）、Read、Wirte 状态。</li>
<li>readyOps() ：查看 Channel 对象可操作的状态集合</li>
<li>channel() ：获取 Channel 对象</li>
<li>selector()：获取 Selector 对象</li>
<li>attachment()：附加一个对象或更多信息</li>
</ul>
<p>使用 Selector 选择 Channel：</p>
<ul>
<li>select()：获取处于就绪状态的 Channel 对象数量</li>
</ul>
</li>
<li><p><strong>Channel</strong></p>
<p>双向通道，替换了 IO 中的 Stream，不能直接访问数据，要通过 Buffer 来读写数据，也可以和其他 Channel 交互。</p>
<p>分类：</p>
<ul>
<li><p>FileChannel（处理文件）</p>
</li>
<li><p>DatagramChannel（处理 UDP 数据）</p>
</li>
<li><p>SocketChannel（处理 TCP 数据，用作客户端）</p>
</li>
<li><p>ServerSocketChannel（处理 TCP 数据，用作服务器端）。</p>
</li>
</ul>
</li>
<li><p><strong>Buffer</strong></p>
<p>缓冲区，本质是一块可读写数据的内存，这块内存被包装成 NIO 的 Buffer 对象，用来简化数据的读写。Buffer 的三个重要属性：position 表示下一次读写数据的位置，limit 表示本次读写的极限位置，capacity 表示最大容量。</p>
<ul>
<li><code>flip()</code> 将写转为读，底层实现原理是把 position 置 0，并把 limit 设为当前的 position 值。</li>
<li>通过<code>clear()</code> 将读转为写模式（用于读完全部数据的情况，把 position 置 0，limit 设为 capacity）。</li>
<li>通过<code>compact()</code> 将读转为写模式（用于没有读完全部数据，存在未读数据的情况，让 position 指向未读数据的下一个）。</li>
<li><font color="red"><strong>通道的方向和 Buffer 的方向是相反的，读取数据相当于向 Buffer 写入，写出数据相当于从 Buffer 读取。</strong></font>

</li>
</ul>
<p>使用步骤：</p>
<ul>
<li>向 Buffer 写入数据</li>
<li>调用 flip 方法将 Buffer 从写模式切换为读模式</li>
<li>从 Buffer 中读取数据</li>
<li>调用 clear 或 compact 方法来清空 Buffer</li>
</ul>
</li>
</ul>
<hr>
<h3 id="本地文件拷贝"><a href="#本地文件拷贝" class="headerlink" title="本地文件拷贝"></a>本地文件拷贝</h3><p>使用 4 种方法进行本地文件的拷贝，分别是不使用/使用缓冲区的 BIO 方式，使用 Buffer/直接使用 Channel 的 NIO 方式。</p>
<p>其中不使用缓冲区的 BIO 效率最低，其余效率差不多，直接使用 Channel 的 NIO 方式效率较高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 拷贝文件的接口 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileCopy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拷贝文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source 拷贝文件源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 拷贝文件目的地</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(File source, File target)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileCopyDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BIO 不使用缓冲区</span></span><br><span class="line">        FileCopy noBufferStreamCopy = (source, target) -&gt; &#123;</span><br><span class="line">            InputStream is = <span class="keyword">null</span>;</span><br><span class="line">            OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                is = <span class="keyword">new</span> FileInputStream(source);</span><br><span class="line">                os = <span class="keyword">new</span> FileOutputStream(target);</span><br><span class="line">                <span class="keyword">int</span> read;</span><br><span class="line">                <span class="keyword">while</span> ((read = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    os.write(read);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                close(is);</span><br><span class="line">                close(os);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BIO 使用缓冲区</span></span><br><span class="line">        FileCopy bufferStreamCopy = (source, target) -&gt; &#123;</span><br><span class="line">            InputStream is = <span class="keyword">null</span>;</span><br><span class="line">            OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(source));</span><br><span class="line">                os = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(target));</span><br><span class="line">                <span class="keyword">int</span> read;</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> ((read = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    os.write(buffer, <span class="number">0</span> ,read);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                close(is);</span><br><span class="line">                close(os);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// NIO 使用 Buffer 交互</span></span><br><span class="line">        FileCopy nioBufferCopy = (source, target) -&gt; &#123;</span><br><span class="line">            FileChannel in = <span class="keyword">null</span>;</span><br><span class="line">            FileChannel out = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in = <span class="keyword">new</span> FileInputStream(source).getChannel();</span><br><span class="line">                out = <span class="keyword">new</span> FileOutputStream(target).getChannel();</span><br><span class="line">                <span class="comment">// 分配一个大小为 1024KB 的缓冲区</span></span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                <span class="keyword">while</span> ((in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// 将 Buffer 的写模式转为读模式（读取数据 = 向 Buffer 写）</span></span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    <span class="comment">// 只要还有数据就全部写出</span></span><br><span class="line">                    <span class="keyword">while</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">                        out.write(buffer);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将 Buffer 的读模式转为写模式（写出数据 = 从 Buffer 读）</span></span><br><span class="line">                    buffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                close(in);</span><br><span class="line">                close(out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//NIO 直接使用 Channel 交互</span></span><br><span class="line">        FileCopy nioTransferCopy = (source, target) -&gt; &#123;</span><br><span class="line">            FileChannel in = <span class="keyword">null</span>;</span><br><span class="line">            FileChannel out = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in = <span class="keyword">new</span> FileInputStream(source).getChannel();</span><br><span class="line">                out = <span class="keyword">new</span> FileOutputStream(target).getChannel();</span><br><span class="line">                <span class="keyword">long</span> transferred = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">long</span> size = in.size();</span><br><span class="line">                <span class="keyword">while</span> (transferred != size) &#123;</span><br><span class="line">                    transferred += in.transferTo(<span class="number">0</span>, size, out);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                close(in);</span><br><span class="line">                close(out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="使用-NIO-改写多人聊天室"><a href="#使用-NIO-改写多人聊天室" class="headerlink" title="使用 NIO 改写多人聊天室"></a>使用 NIO 改写多人聊天室</h3><p>服务器端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 结束条件 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务端 Channel */</span></span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel server;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Selector 选择器 */</span></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 读缓冲 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer readBuffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 写缓冲 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer writeBuffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 使用的编码 */</span></span><br><span class="line">    <span class="keyword">private</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 可以自定义服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">(<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看用户是否准备退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示准备退出，反之</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span> <span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QUIT.equals(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 释放资源 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(closeable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getClientName</span><span class="params">(SocketChannel client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"客户端["</span> + client.socket().getPort() + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardMessage</span><span class="params">(SocketChannel client, String message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 遍历所有注册的 channel</span></span><br><span class="line">        Set&lt;SelectionKey&gt; selectionKeys = selector.keys();</span><br><span class="line">        <span class="keyword">for</span>(SelectionKey selectionKey : selectionKeys) &#123;</span><br><span class="line">            Channel channel = selectionKey.channel();</span><br><span class="line">            <span class="comment">// 是服务端的 channel 则跳过</span></span><br><span class="line">            <span class="keyword">if</span> (channel <span class="keyword">instanceof</span>  ServerSocketChannel) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// channel 有效且不是发送消息的客户端 channel</span></span><br><span class="line">            <span class="keyword">if</span> (selectionKey.isValid() &amp;&amp; !client.equals(channel)) &#123;</span><br><span class="line">                <span class="comment">// 向 Buffer 写入数据，准备发送</span></span><br><span class="line">                writeBuffer.clear();</span><br><span class="line">                writeBuffer.put(charset.encode(getClientName(client) + <span class="string">":"</span> + message));</span><br><span class="line">                writeBuffer.flip();</span><br><span class="line">                <span class="comment">// 从 Buffer 读取数据并发送</span></span><br><span class="line">                <span class="keyword">while</span> (writeBuffer.hasRemaining()) &#123;</span><br><span class="line">                    ((SocketChannel)channel).write(writeBuffer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取消息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">receive</span><span class="params">(SocketChannel client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 清空残留信息，将读模式转为写模式</span></span><br><span class="line">        readBuffer.clear();</span><br><span class="line">        <span class="comment">// 接收消息，相等于向 Buffer 写数据</span></span><br><span class="line">        <span class="keyword">while</span> (client.read(readBuffer) &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 写完后将写模式转为读模式</span></span><br><span class="line">        readBuffer.flip();</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(charset.decode(readBuffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 处理事件 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handles</span><span class="params">(SelectionKey selectionKey)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">// 如果触发了 ACCEPT 事件 —— 和客户端建立了连接</span></span><br><span class="line">        <span class="keyword">if</span> (selectionKey.isAcceptable()) &#123;</span><br><span class="line">            ServerSocketChannel server = (ServerSocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 获取客户端的 channel</span></span><br><span class="line">            SocketChannel client = server.accept();</span><br><span class="line">            <span class="comment">// 设为非阻塞调用模式</span></span><br><span class="line">            client.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 注册客户端的 READ 事件到 selector</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">            System.out.println(getClientName(client)  + <span class="string">"已连接服务器"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isReadable())&#123;</span><br><span class="line">            <span class="comment">// 如果触发了 READ 事件 —— 客户端发送了数据</span></span><br><span class="line">            SocketChannel client = (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 读取数据</span></span><br><span class="line">            String message = receive(client);</span><br><span class="line">            <span class="keyword">if</span> (message.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// 消息为空，客户端异常，取消监听</span></span><br><span class="line">                selectionKey.cancel();</span><br><span class="line">                <span class="comment">// 刷新</span></span><br><span class="line">                selector.wakeup();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 转发消息</span></span><br><span class="line">                forwardMessage(client, message);</span><br><span class="line">                <span class="comment">// 查看用户是否准备退出</span></span><br><span class="line">                <span class="keyword">if</span>(checkQuit(message)) &#123;</span><br><span class="line">                    selectionKey.cancel();</span><br><span class="line">                    selector.wakeup();</span><br><span class="line">                    System.out.println(getClientName(client) + <span class="string">"已断开连接"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 启动服务器端开始监听 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// 设置非阻塞调用</span></span><br><span class="line">            server.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 绑定监听端口</span></span><br><span class="line">            ServerSocket serverSocket = server.socket();</span><br><span class="line">            serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">            <span class="comment">// 创建 selector</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 注册服务器 Channel 的 ACCEPT（接收客户端请求） 事件到 selector</span></span><br><span class="line">            server.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">            System.out.println(<span class="string">"启动服务器，监听端口："</span> + port + <span class="string">"..."</span>);</span><br><span class="line">            <span class="comment">// 不断监听请求</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// select 是阻塞式调用，如果成功调用说明已有 Channel 就绪</span></span><br><span class="line">                selector.select();</span><br><span class="line">                <span class="comment">// select 监听到的所有事件</span></span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                <span class="keyword">for</span> (SelectionKey selectionKey : selectionKeys) &#123;</span><br><span class="line">                    <span class="comment">// 处理被触发的事件</span></span><br><span class="line">                    handles(selectionKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理后清空</span></span><br><span class="line">                selectionKeys.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args main方法参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ChatServer chatServer = <span class="keyword">new</span> ChatServer();</span><br><span class="line">        chatServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器默认主机 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_HOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器默认端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 结束条件 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 和服务器通信的 socket */</span></span><br><span class="line">    <span class="keyword">private</span> SocketChannel client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 读取缓冲 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer readBuffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 写出缓冲 */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer writeBuffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Selector 选择器 */</span></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 使用的编码 */</span></span><br><span class="line">    <span class="keyword">private</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_HOST, DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatClient</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向服务器发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 要发送的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 读模式转写模式</span></span><br><span class="line">        writeBuffer.clear();</span><br><span class="line">        writeBuffer.put(charset.encode(message));</span><br><span class="line">        <span class="comment">// 写模式转读模式</span></span><br><span class="line">        writeBuffer.flip();</span><br><span class="line">        <span class="keyword">while</span> (writeBuffer.hasRemaining()) &#123;</span><br><span class="line">            client.write(writeBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断用户是否准备退出</span></span><br><span class="line">        <span class="keyword">if</span> (checkQuit(message)) &#123;</span><br><span class="line">            close(selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看用户是否准备退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示准备退出，反之</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span> <span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QUIT.equals(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 释放资源 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(closeable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 启动客户端 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 channel</span></span><br><span class="line">            client = SocketChannel.open();</span><br><span class="line">            <span class="comment">// 设置非阻塞调用</span></span><br><span class="line">            client.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 创建 selector</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 注册客户端 channel 的 CONNECT 事件到 selector</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line">            <span class="comment">// 客户端向服务器发起连接请求</span></span><br><span class="line">            client.connect(<span class="keyword">new</span> InetSocketAddress(host, port));</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// select 是阻塞式调用，如果成功调用说明已有 Channel 就绪</span></span><br><span class="line">                selector.select();</span><br><span class="line">                <span class="comment">// select 监听到的所有事件</span></span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                <span class="keyword">for</span> (SelectionKey selectionKey : selectionKeys) &#123;</span><br><span class="line">                    <span class="comment">// 处理被触发的事件</span></span><br><span class="line">                    handles(selectionKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理后清空</span></span><br><span class="line">                selectionKeys.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClosedSelectorException e) &#123;</span><br><span class="line">            <span class="comment">// 用户正常退出</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handles</span><span class="params">(SelectionKey selectionKey)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 如果触发了 CONNECT 事件 —— 连接就绪事件</span></span><br><span class="line">        <span class="keyword">if</span> (selectionKey.isConnectable()) &#123;</span><br><span class="line">            SocketChannel client = (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 如果连接已经建立了</span></span><br><span class="line">            <span class="keyword">if</span> (client.isConnectionPending()) &#123;</span><br><span class="line">                client.finishConnect();</span><br><span class="line">                <span class="comment">// 处理用户输入</span></span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> UserInputHandler(<span class="keyword">this</span>)).start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注册客户端的 READ 事件到 selector</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isReadable()) &#123;</span><br><span class="line">            <span class="comment">// 如果触发了 READ 事件 —— 服务器转发了数据</span></span><br><span class="line">            SocketChannel client = (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 读取数据</span></span><br><span class="line">            String message = receive(client);</span><br><span class="line">            <span class="keyword">if</span> (message.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// 消息为空，服务器异常，取消监听</span></span><br><span class="line">                close(selector);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">receive</span><span class="params">(SocketChannel client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        readBuffer.clear();</span><br><span class="line">        <span class="keyword">while</span> (client.read(readBuffer) &gt; <span class="number">0</span>);</span><br><span class="line">        readBuffer.flip();</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(charset.decode(readBuffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ChatClient chatClient = <span class="keyword">new</span> ChatClient();</span><br><span class="line">        <span class="comment">// 启动客户端</span></span><br><span class="line">        chatClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理用户输入的类 UserInputHandler 代码不变。</p>
<hr>
<h2 id="AIO-异步非阻塞"><a href="#AIO-异步非阻塞" class="headerlink" title="AIO 异步非阻塞"></a>AIO 异步非阻塞</h2><p>服务器端通道AsynchronousServerSocketChannel，通过 accept 获取客户端连接</p>
<p>客户端通道 AsynchronousSocketChannel，通过 connect 连接服务器</p>
<p>实现方式：</p>
<ul>
<li>通过 Future 的 get 阻塞式调用</li>
<li>通过实现 CompletionHandler 接口，重写回调方法 completed 和 failed</li>
</ul>
<hr>
<h3 id="回音聊天室"><a href="#回音聊天室" class="headerlink" title="回音聊天室"></a>回音聊天室</h3><p>实现功能：可以将用户发送给服务器的消息再返回给用户，类似“回音”效果。</p>
<p>服务器代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String LOCALHOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 异步的服务器端 channel */</span></span><br><span class="line">    AsynchronousServerSocketChannel serverChannel;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Server().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 绑定监听的端口</span></span><br><span class="line">            serverChannel = AsynchronousServerSocketChannel.open();</span><br><span class="line">            serverChannel.bind(<span class="keyword">new</span> InetSocketAddress(LOCALHOST, DEFAULT_PORT));</span><br><span class="line">            System.out.println(<span class="string">"启动服务器，监听端口："</span> + DEFAULT_PORT);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 异步调用，接收客户端请求</span></span><br><span class="line">                serverChannel.accept(<span class="keyword">null</span>, <span class="keyword">new</span> AcceptHandler());</span><br><span class="line">                <span class="comment">// 控制调用频率</span></span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(serverChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeable 要释放的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">                System.out.println(<span class="string">"关闭"</span> + closeable);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理异步 ACCEPT 事件的方法，第一个泛型参数是成功回调的 result 类型，第二个泛型参数是 attachment 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">AsynchronousSocketChannel</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 成功的回调方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> result 和服务器建立连接的客户端 channel</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> attachment 额外数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel result, Object attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 让服务器继续监听其他客户端</span></span><br><span class="line">            <span class="keyword">if</span> (serverChannel.isOpen()) &#123;</span><br><span class="line">                serverChannel.accept(<span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            AsynchronousSocketChannel clientChannel = result;</span><br><span class="line">            <span class="keyword">if</span> (clientChannel != <span class="keyword">null</span> &amp;&amp; clientChannel.isOpen()) &#123;</span><br><span class="line">                <span class="comment">// 处理异步 read</span></span><br><span class="line">                ClientHandler clientHandler = <span class="keyword">new</span> ClientHandler(clientChannel);</span><br><span class="line">                <span class="comment">// 读取客户端数据</span></span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                <span class="comment">// 附加信息，一个 map 集合</span></span><br><span class="line">                Map&lt;String, Object&gt; info = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                info.put(<span class="string">"type"</span>, <span class="string">"read"</span>);</span><br><span class="line">                info.put(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">                <span class="comment">// 异步调用 read，相当于向 buffer 写数据，buffer 是写模式</span></span><br><span class="line">                clientChannel.read(buffer, info, clientHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 失败的回调方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exc 异常</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> attachment 额外数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 处理错误</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理读写事件，第一个参数表示 Buffer 写入的字节</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> AsynchronousSocketChannel clientChannel;</span><br><span class="line"></span><br><span class="line">        ClientHandler(AsynchronousSocketChannel clientChannel) &#123;</span><br><span class="line">            <span class="keyword">this</span>.clientChannel = clientChannel;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, Object attachment)</span> </span>&#123;</span><br><span class="line">            Map&lt;String, Object&gt; info = (Map&lt;String, Object&gt;) attachment;</span><br><span class="line">            <span class="comment">// 判断操作类型是 read 还是 write</span></span><br><span class="line">            String type = (String) info.get(<span class="string">"type"</span>);</span><br><span class="line">            <span class="comment">// 读完客户端数据后写出</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"read"</span>.equals(type)) &#123;</span><br><span class="line">                ByteBuffer buffer = (ByteBuffer) info.get(<span class="string">"buffer"</span>);</span><br><span class="line">                <span class="comment">// 将 buffer 从写模式转为读模式</span></span><br><span class="line">                buffer.flip();</span><br><span class="line">                info.put(<span class="string">"type"</span>, <span class="string">"write"</span>);</span><br><span class="line">                <span class="comment">// 写出数据，相当于从 buffer 读</span></span><br><span class="line">                clientChannel.write(buffer, info, <span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// 将 buffer 从读模式转为写模式</span></span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"write"</span>.equals(type)) &#123;</span><br><span class="line">                <span class="comment">// 写出后继续读取客户端数据</span></span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                info.put(<span class="string">"type"</span>, <span class="string">"read"</span>);</span><br><span class="line">                info.put(<span class="string">"buffer"</span>, buffer);</span><br><span class="line">                <span class="comment">// 异步调用 read</span></span><br><span class="line">                clientChannel.read(buffer, info, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//处理错误</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String LOCALHOST = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 异步的客户端 channel */</span></span><br><span class="line">    AsynchronousSocketChannel clientChannel;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Client().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 channel</span></span><br><span class="line">            clientChannel = AsynchronousSocketChannel.open();</span><br><span class="line">            Future&lt;Void&gt; future = clientChannel.connect(<span class="keyword">new</span> InetSocketAddress(LOCALHOST, DEFAULT_PORT));</span><br><span class="line">            <span class="comment">// get 是阻塞式调用，在客户端和服务器建立连接前会阻塞</span></span><br><span class="line">            future.get();</span><br><span class="line">            <span class="comment">// 等待用户输入</span></span><br><span class="line">            BufferedReader consoleReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                String input = consoleReader.readLine();</span><br><span class="line">                <span class="comment">// 将用户消息发送给服务器</span></span><br><span class="line">                <span class="keyword">byte</span>[] inputBytes = input.getBytes();</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.wrap(inputBytes);</span><br><span class="line">                Future&lt;Integer&gt; writeResult = clientChannel.write(buffer);</span><br><span class="line">                <span class="comment">// 阻塞直到消息成功发送</span></span><br><span class="line">                writeResult.get();</span><br><span class="line">                <span class="comment">// 从服务器读取响应消息</span></span><br><span class="line">                <span class="comment">// 写出数据相当于从 Buffer 读，所以现在将读转为写模式</span></span><br><span class="line">                buffer.clear();</span><br><span class="line">                Future&lt;Integer&gt; readResult = clientChannel.read(buffer);</span><br><span class="line">                <span class="comment">// 阻塞直到成功读取消息</span></span><br><span class="line">                readResult.get();</span><br><span class="line">                String echo = <span class="keyword">new</span> String(buffer.array());</span><br><span class="line">                <span class="comment">// 读取数据相当于向 Buffer 写，所以现在将写转为读模式</span></span><br><span class="line">                buffer.flip();</span><br><span class="line">                System.out.println(echo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(clientChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeable 要释放的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">                System.out.println(<span class="string">"关闭"</span> + closeable);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="使用-AIO-改写多人聊天室"><a href="#使用-AIO-改写多人聊天室" class="headerlink" title="使用 AIO 改写多人聊天室"></a>使用 AIO 改写多人聊天室</h3><p>服务器端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器主机 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCALHOST = <span class="string">"localhost"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 结束条件 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 缓冲区大小 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 线程池大小 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREAD_POOL_SIZE = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 自定义 ChannelGroup */</span></span><br><span class="line">    <span class="keyword">private</span> AsynchronousChannelGroup channelGroup;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 服务端 Channel */</span></span><br><span class="line">    <span class="keyword">private</span> AsynchronousServerSocketChannel serverChannel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 使用的编码 */</span></span><br><span class="line">    <span class="keyword">private</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 可以自定义服务器端口 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 存储用户在线列表 */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ClientHandler&gt; connectedClients;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">(<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">        <span class="keyword">this</span>.connectedClients = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序入口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ChatServer().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动服务器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建自定义 channel group</span></span><br><span class="line">            ExecutorService executorService = Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span><br><span class="line">            channelGroup = AsynchronousChannelGroup.withThreadPool(executorService);</span><br><span class="line">            <span class="comment">// 创建 channel 并绑定 group 和端口</span></span><br><span class="line">            serverChannel = AsynchronousServerSocketChannel.open(channelGroup);</span><br><span class="line">            serverChannel.bind(<span class="keyword">new</span> InetSocketAddress(LOCALHOST, port));</span><br><span class="line">            System.out.println(<span class="string">"启动服务器，监听端口："</span> + port);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 接收客户端请求并处理</span></span><br><span class="line">                serverChannel.accept(<span class="keyword">null</span>, <span class="keyword">new</span> AcceptHandler());</span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(serverChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看用户是否准备退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户发送的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示准备退出，反之</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span> <span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QUIT.equals(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取客户端名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientChannel 客户端 channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回客户端名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getClientName</span><span class="params">(AsynchronousSocketChannel clientChannel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> clientPort = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InetSocketAddress inetSocketAddress = (InetSocketAddress) clientChannel.getRemoteAddress();</span><br><span class="line">            clientPort = inetSocketAddress.getPort();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"客户端["</span> + clientPort + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务器转发消息给其他客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientChannel 发送消息的客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 发送的具体消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">forwardMessage</span><span class="params">(AsynchronousSocketChannel clientChannel, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ClientHandler handler : connectedClients)&#123;</span><br><span class="line">            <span class="comment">// 该信息不用再转发到发送信息的客户端</span></span><br><span class="line">            <span class="keyword">if</span> (!handler.clientChannel.equals(clientChannel))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 将要转发的信息写入到 buffer 中</span></span><br><span class="line">                    ByteBuffer buffer = charset.encode(getClientName(handler.clientChannel) + <span class="string">":"</span> + message);</span><br><span class="line">                    <span class="comment">// 写事件不添加附加信息</span></span><br><span class="line">                    handler.clientChannel.write(buffer,<span class="keyword">null</span>, handler);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务器接收客户端消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buffer buffer 缓冲区</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回接收的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> String <span class="title">receive</span><span class="params">(ByteBuffer buffer)</span> </span>&#123;</span><br><span class="line">        CharBuffer charBuffer = charset.decode(buffer);</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(charBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个新的客户端进到在线列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler 客户端对应的 handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ClientHandler handler)</span> </span>&#123;</span><br><span class="line">        connectedClients.add(handler);</span><br><span class="line">        System.out.println(getClientName(handler.clientChannel) + <span class="string">"已经连接到服务器"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将下线用户从在线列表中删除</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientHandler 客户端对应的 handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ClientHandler clientHandler)</span> </span>&#123;</span><br><span class="line">        connectedClients.remove(clientHandler);</span><br><span class="line">        System.out.println(getClientName(clientHandler.clientChannel) + <span class="string">"已断开连接"</span>);</span><br><span class="line">        <span class="comment">// 关闭该客户对应流</span></span><br><span class="line">        close(clientHandler.clientChannel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(closeable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理服务器的 ACCEPT 事件，第一个泛型参数是异步调用方法应该返回的类型，ACCEPT 应该返回一个客户端的 channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">AsynchronousSocketChannel</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel clientChannel, Object attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 让服务器继续监听其他客户端</span></span><br><span class="line">            <span class="keyword">if</span> (serverChannel.isOpen()) &#123;</span><br><span class="line">                serverChannel.accept(<span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 客户端处于有效状态</span></span><br><span class="line">            <span class="keyword">if</span> (clientChannel != <span class="keyword">null</span> &amp;&amp; clientChannel.isOpen()) &#123;</span><br><span class="line">                <span class="comment">// 处理异步 read</span></span><br><span class="line">                ClientHandler clientHandler = <span class="keyword">new</span> ClientHandler(clientChannel);</span><br><span class="line">                <span class="comment">// 读取客户端数据</span></span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line">                <span class="comment">// 将新用户添加到在线用户列表</span></span><br><span class="line">                addClient(clientHandler);</span><br><span class="line">                <span class="comment">// 异步调用 read，向 buffer 写数据，因此此时 buffer 是写模式。</span></span><br><span class="line">                <span class="comment">// 第二个参数表示将 buffer 作为附加信息，第三个参数表示处理异步读的 handler</span></span><br><span class="line">                clientChannel.read(buffer, buffer, clientHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"连接失败："</span> + exc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理客户端的读写事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> AsynchronousSocketChannel clientChannel;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClientHandler</span><span class="params">(AsynchronousSocketChannel clientChannel)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.clientChannel = clientChannel;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, Object attachment)</span> </span>&#123;</span><br><span class="line">            ByteBuffer buffer = (ByteBuffer) attachment;</span><br><span class="line">            <span class="comment">// buffer 附加信息不为空，说明处理的是异步读</span></span><br><span class="line">            <span class="keyword">if</span> (buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 客户端异常</span></span><br><span class="line">                    removeClient(<span class="keyword">this</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 将 buffer 从写模式转为读模式，准备写出数据</span></span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    String message = receive(buffer);</span><br><span class="line">                    System.out.println(getClientName(clientChannel) + <span class="string">":"</span> + message);</span><br><span class="line">                    forwardMessage(clientChannel, message);</span><br><span class="line">                    <span class="comment">// 将 buffer 转回写模式</span></span><br><span class="line">                    buffer.clear();</span><br><span class="line">                    <span class="comment">// 判断用户是否准备下线</span></span><br><span class="line">                    <span class="keyword">if</span> (checkQuit(message))&#123;</span><br><span class="line">                        <span class="comment">// 将用户从在线客户列表中去除</span></span><br><span class="line">                        removeClient(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果不是则继续等待读取用户输入的信息</span></span><br><span class="line">                        clientChannel.read(buffer, buffer,<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"读写失败:"</span>+exc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCALHOST = <span class="string">"localhost"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUIT = <span class="string">"quit"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AsynchronousSocketChannel clientChannel;</span><br><span class="line">    <span class="keyword">private</span> Charset charset = StandardCharsets.UTF_8;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(LOCALHOST , DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatClient</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序入口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ChatClient client = <span class="keyword">new</span> ChatClient();</span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断用户是否准备下线</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg 用户输入的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否准备下线</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkQuit</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> flag = QUIT.equalsIgnoreCase(msg);</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            close(clientChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端发送数据给服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 要发送的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将要发送的消息编码并写入缓冲区</span></span><br><span class="line">        ByteBuffer writeBuffer = charset.encode(message);</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        Future&lt;Integer&gt; writeResult = clientChannel.write(writeBuffer);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 阻塞直到发送结束</span></span><br><span class="line">            writeResult.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"发送消息失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeable 要释放的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(closeable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 打开管道</span></span><br><span class="line">            clientChannel = AsynchronousSocketChannel.open();</span><br><span class="line">            <span class="comment">// 异步调用connect连接服务器</span></span><br><span class="line">            Future&lt;Void&gt; future = clientChannel.connect(<span class="keyword">new</span> InetSocketAddress(host, port));</span><br><span class="line">            <span class="comment">// 阻塞直到客户端和服务器建立连接</span></span><br><span class="line">            future.get();</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> UserInputHandler(<span class="keyword">this</span>)).start();</span><br><span class="line">            <span class="comment">// 读取服务器转发的消息</span></span><br><span class="line">            ByteBuffer readBuffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Future&lt;Integer&gt; readResult = clientChannel.read(readBuffer);</span><br><span class="line">                <span class="comment">// 阻塞直到读取完毕</span></span><br><span class="line">                <span class="keyword">int</span> result = readResult.get();</span><br><span class="line">                <span class="comment">// 假如无法读到数据</span></span><br><span class="line">                <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"服务器断开连接"</span>);</span><br><span class="line">                    close(clientChannel);</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 成功读取到了数据，打印在控制台</span></span><br><span class="line">                    <span class="comment">// 先把缓冲区转为读模式</span></span><br><span class="line">                    readBuffer.flip();</span><br><span class="line">                    String message = String.valueOf(charset.decode(readBuffer));</span><br><span class="line">                    System.out.println(message);</span><br><span class="line">                    <span class="comment">// 读完将缓冲区转为写模式</span></span><br><span class="line">                    readBuffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(clientChannel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理用户输入的类 UserInputHandler 代码不变。</p>
<hr>
<h2 id="简易-Web-服务器的实现"><a href="#简易-Web-服务器的实现" class="headerlink" title="简易 Web 服务器的实现"></a>简易 Web 服务器的实现</h2><p>在客户端向服务器请求资源时，请求的资源可以分为：</p>
<ul>
<li>静态资源：不因请求的次数或顺序变化，例如 HTML、CSS、GIF、PNG 等。</li>
<li>动态资源：随着请求发起方/发起时间/请求内容等因素变化，例如商品库存量等。客户端发起请求，服务器将请求交给容器，容器再交给 Servlet 处理，处理完后再返回给容器、服务器及客户端。</li>
</ul>
<p>Tomcat 的结构：</p>
<ul>
<li><p>Server：Tomocat 服务器最顶层的组件，负责运行 Tomcat 服务器、加载服务器资源和环境变量。</p>
</li>
<li><p>Service：集合了 Connector 和 Engine 的抽象组件，一个 Service 可以包含多个 Service，多个 Connector 和 一个 Engine。</p>
</li>
<li>Connector：提供基于不同特定协议的实现，接收解析请求并返回响应。具体包括负责提供给客户端可以和服务器创建连接的端点、接收连接请求和建立连接后的资源请求、将服务器的响应返回给客户等。Connector 本身不会处理请求，会将请求交给 Processor 派遣至 Engine 进行处理。</li>
<li>容器是 Tomcat 用来处理请求的组件，内部的组件按照层级排列，其中 Engine 是容器的顶级组件。Engine 通过解析请求内容将请求交发送给对应的 Host，Host 代表一个虚拟主机，一个 Engine 可以支持对多个虚拟主机的请求。Host 将请求交给 Context 组件，Context 代表一个 Web Application，是 Tomcat 最复杂的组件之一，负责应用资源管理、应用类加载、Servlet 管理、安全管理等。Context 下一层是 Wrapper 组件，Wrapper 是容器最底层的组件，包裹 Servlet 实例，负责管理 Servlet 的生命周期。</li>
</ul>
<hr>
<h3 id="处理静态资源请求"><a href="#处理静态资源请求" class="headerlink" title="处理静态资源请求"></a>处理静态资源请求</h3><h4 id="HTTPStatus-状态码枚举类"><a href="#HTTPStatus-状态码枚举类" class="headerlink" title="HTTPStatus 状态码枚举类"></a>HTTPStatus 状态码枚举类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> HTTPStatus &#123;</span><br><span class="line"></span><br><span class="line">    OK(<span class="number">200</span>, <span class="string">"OK"</span>),</span><br><span class="line">    NOT_FOUND(<span class="number">404</span>, <span class="string">"File Not Found"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> statusCode;</span><br><span class="line">    <span class="keyword">private</span> String reason;</span><br><span class="line"></span><br><span class="line">    HTTPStatus(<span class="keyword">int</span> statusCode, String reason) &#123;</span><br><span class="line">        <span class="keyword">this</span>.statusCode = statusCode;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatusCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getReason</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  reason;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ConnectorUtils-工具类"><a href="#ConnectorUtils-工具类" class="headerlink" title="ConnectorUtils 工具类"></a>ConnectorUtils 工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectorUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 存放静态资源的根路径 根据自己的情况设置 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_ROOT = <span class="string">"C:\\Users\\Administrator\\IdeaProjects\\java_study\\test"</span> + File.separator + <span class="string">"webroot"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROTOCOL = <span class="string">"HTTP/1.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CARRIAGE = <span class="string">"\r"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NEWLINE = <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPACE = <span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">renderStatus</span><span class="params">(HTTPStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 协议 + 状态 + 状态码</span></span><br><span class="line">        <span class="keyword">return</span> PROTOCOL + SPACE + status.getStatusCode() + SPACE + status.getReason() + CARRIAGE + NEWLINE + CARRIAGE + NEWLINE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Request-处理请求"><a href="#Request-处理请求" class="headerlink" title="Request 处理请求"></a>Request 处理请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认缓冲区大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端和服务器的 socket 的输入流，通过该流获取请求内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> InputStream inputStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求的资源标识符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String URI;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inputStream = inputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取请求 URI</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回 URI 字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getURI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> URI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析客户端请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            len = inputStream.read(buffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将读取到的字节数组转为字符串</span></span><br><span class="line">        String requestURL = <span class="keyword">new</span> String(buffer, <span class="number">0</span>, len);</span><br><span class="line">        URI = parseURI(requestURL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析静态请求的 URI</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestStr 请求文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回 URI</span></span><br><span class="line"><span class="comment">     * 例如 GET /index.html HTTP1.1，先找到第一个空格的位置，再找到第二个空格的位置，截取两个位置中间作为结果返回。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">parseURI</span><span class="params">(String requestStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index1, index2;</span><br><span class="line">        index1 = requestStr.indexOf(<span class="string">' '</span>);</span><br><span class="line">        <span class="keyword">if</span>(index1 != -<span class="number">1</span>) &#123;</span><br><span class="line">            index2 = requestStr.indexOf(<span class="string">' '</span>, index1 + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (index2 != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> requestStr.substring(index1 + <span class="number">1</span>, index2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 无法解析出 URI</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Response-处理响应"><a href="#Response-处理响应" class="headerlink" title="Response 处理响应"></a>Response 处理响应</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认缓冲区大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Request request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端和服务器的 socket 的输出流，通过该流响应客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> OutputStream outputStream;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(OutputStream outputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.outputStream =outputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置客户端请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 客户端请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应静态资源的请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStaticResource</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(ConnectorUtils.WEB_ROOT, request.getURI());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 成功处理</span></span><br><span class="line">            write(file, HTTPStatus.OK);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// 失败处理</span></span><br><span class="line">            write(<span class="keyword">new</span> File(ConnectorUtils.WEB_ROOT, <span class="string">"404.html"</span>), HTTPStatus.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(File resource, HTTPStatus status)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(resource))&#123;</span><br><span class="line">            <span class="comment">// 响应状态信息</span></span><br><span class="line">            outputStream.write(ConnectorUtils.renderStatus(status).getBytes());</span><br><span class="line">            <span class="comment">// 响应资源</span></span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">            <span class="keyword">int</span> length;</span><br><span class="line">            <span class="keyword">while</span> ((length = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                outputStream.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="StaticProcessor-处理静态资源"><a href="#StaticProcessor-处理静态资源" class="headerlink" title="StaticProcessor 处理静态资源"></a>StaticProcessor 处理静态资源</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理静态资源的 processor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.sendStaticResource();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Connector-处理服务器连接、请求、响应"><a href="#Connector-处理服务器连接、请求、响应" class="headerlink" title="Connector 处理服务器连接、请求、响应"></a>Connector 处理服务器连接、请求、响应</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Connector</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 绑定端口</span></span><br><span class="line">            serverSocket = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">            System.out.println(<span class="string">"服务器已启动，监听端口："</span> + port);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 等待客户端连接</span></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                <span class="comment">// 客户端输入流</span></span><br><span class="line">                InputStream inputStream = socket.getInputStream();</span><br><span class="line">                <span class="comment">// 客户端输出流</span></span><br><span class="line">                OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">                <span class="comment">// 创建 Request 实例并解析 URI</span></span><br><span class="line">                Request request = <span class="keyword">new</span> Request(inputStream);</span><br><span class="line">                request.parse();</span><br><span class="line">                <span class="comment">// 创建 Response 实例并设置 request</span></span><br><span class="line">                Response response = <span class="keyword">new</span> Response(outputStream);</span><br><span class="line">                response.setRequest(request);</span><br><span class="line">                <span class="comment">// 处理静态资源</span></span><br><span class="line">                StaticProcessor staticProcessor = <span class="keyword">new</span> StaticProcessor();</span><br><span class="line">                staticProcessor.process(request, response);</span><br><span class="line">                <span class="comment">// 处理完后断开连接</span></span><br><span class="line">                close(socket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(serverSocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeable 要关闭的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="BootStrap-服务器启动类"><a href="#BootStrap-服务器启动类" class="headerlink" title="BootStrap 服务器启动类"></a>BootStrap 服务器启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BootStrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 启动服务器</span></span><br><span class="line">        <span class="keyword">new</span> Connector().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ClientTest-客户端测试类"><a href="#ClientTest-客户端测试类" class="headerlink" title="ClientTest 客户端测试类"></a>ClientTest 客户端测试类</h4><p>也可以直接在浏览器输入 <code>localhost:8080/index.html</code> 进行测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 建立客户端 socket，连接服务器</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>, <span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 获取客户端输出流，发送请求</span></span><br><span class="line">        OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">        outputStream.write(<span class="string">"GET /index.html HTTP/1.1"</span>.getBytes());</span><br><span class="line">        socket.shutdownOutput();</span><br><span class="line">        <span class="comment">// 获取客户端输入流，接收响应</span></span><br><span class="line">        InputStream inputStream = socket.getInputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        <span class="keyword">int</span> length;</span><br><span class="line">        <span class="keyword">while</span> ((length = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            String receive = <span class="keyword">new</span> String(buffer, <span class="number">0</span> ,length);</span><br><span class="line">            System.out.print(receive);</span><br><span class="line">        &#125;</span><br><span class="line">        socket.shutdownInput();</span><br><span class="line">        <span class="comment">// 关闭连接</span></span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="处理动态资源请求"><a href="#处理动态资源请求" class="headerlink" title="处理动态资源请求"></a>处理动态资源请求</h3><h4 id="修改-Request-和-Response"><a href="#修改-Request-和-Response" class="headerlink" title="修改 Request 和 Response"></a>修改 Request 和 Response</h4><p>让 Request 和 Response 分别实现 ServletRequest 和 ServletResponse 接口，并使用默认的重写方法，只需要修改 Response 中的 getWriter 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PrintWriter(outputStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ServletProcessor-处理动态资源"><a href="#ServletProcessor-处理动态资源" class="headerlink" title="ServletProcessor 处理动态资源"></a>ServletProcessor 处理动态资源</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理动态资源的 processor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">        URLClassLoader servletLoader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            servletLoader = getServletLoader();</span><br><span class="line">            Servlet servlet = getServlet(servletLoader, request);</span><br><span class="line">            servlet.service(request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">URLClassLoader <span class="title">getServletLoader</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">        File webroot = <span class="keyword">new</span> File(ConnectorUtils.WEB_ROOT);</span><br><span class="line">        URL webrootURL = webroot.toURI().toURL();</span><br><span class="line">        <span class="keyword">return</span> URLClassLoader.newInstance(<span class="keyword">new</span> URL[]&#123;webrootURL&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Servlet <span class="title">getServlet</span><span class="params">(URLClassLoader loader, Request request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 请求 servlet 时，例如请求 XxxServlet 实际请求 servlet/XxxServlet</span></span><br><span class="line">        String URI = request.getURI();</span><br><span class="line">        String servletName = URI.substring(URI.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 通过反射创建 servlet 的实例</span></span><br><span class="line">        Class servletClass = loader.loadClass(servletName);</span><br><span class="line">        Servlet servlet = (Servlet) servletClass.getConstructor().newInstance();</span><br><span class="line">        <span class="keyword">return</span> servlet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="TimeServlet-动态资源"><a href="#TimeServlet-动态资源" class="headerlink" title="TimeServlet 动态资源"></a>TimeServlet 动态资源</h4><p>添加在 webroot下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态资源 servlet</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 得到响应的输出流</span></span><br><span class="line">        PrintWriter writer = servletResponse.getWriter();</span><br><span class="line">        <span class="comment">// 写出响应头</span></span><br><span class="line">        writer.println(ConnectorUtils.renderStatus(HTTPStatus.OK));</span><br><span class="line">        <span class="comment">// 写出当前的时间</span></span><br><span class="line">        writer.println(<span class="string">"当前时间："</span>);</span><br><span class="line">        writer.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="comment">// 不添加可能空数据</span></span><br><span class="line">        writer.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="修改-Connector-的-run-方法"><a href="#修改-Connector-的-run-方法" class="headerlink" title="修改 Connector 的 run 方法"></a>修改 Connector 的 run 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 URI 的开头判断资源类型</span></span><br><span class="line"><span class="keyword">if</span> (request.getURI().startsWith(<span class="string">"/servlet"</span>)) &#123;</span><br><span class="line">    <span class="comment">// 处理动态资源</span></span><br><span class="line">    ServletProcessor servletProcessor = <span class="keyword">new</span> ServletProcessor();</span><br><span class="line">    servletProcessor.process(request, response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 处理静态资源</span></span><br><span class="line">    StaticProcessor staticProcessor = <span class="keyword">new</span> StaticProcessor();</span><br><span class="line">    staticProcessor.process(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ClientTest-客户端测试类-1"><a href="#ClientTest-客户端测试类-1" class="headerlink" title="ClientTest 客户端测试类"></a>ClientTest 客户端测试类</h4><p>也可以直接在浏览器输入 <code>localhost:8080/servlet/TimeServlet</code> 进行测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        outputStream.write(<span class="string">"GET /servlet/TimeServlet HTTP/1.1"</span>.getBytes());</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="使用-NIO-改写-Connector"><a href="#使用-NIO-改写-Connector" class="headerlink" title="使用 NIO 改写 Connector"></a>使用 NIO 改写 Connector</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Connector</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 打开 serverSocket的 Channel</span></span><br><span class="line">            server = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// 设置非阻塞调用</span></span><br><span class="line">            server.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 绑定监听端口</span></span><br><span class="line">            ServerSocket serverSocket = server.socket();</span><br><span class="line">            serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">            <span class="comment">// 创建 selector</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 注册服务器 Channel 的 ACCEPT（接收客户端请求） 事件到 selector</span></span><br><span class="line">            server.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">            System.out.println(<span class="string">"启动服务器，监听端口："</span> + port + <span class="string">"..."</span>);</span><br><span class="line">            <span class="comment">// 不断监听请求</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// select 是阻塞式调用，如果成功调用说明已有 Channel 就绪</span></span><br><span class="line">                selector.select();</span><br><span class="line">                <span class="comment">// select 监听到的所有事件</span></span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                <span class="keyword">for</span> (SelectionKey selectionKey : selectionKeys) &#123;</span><br><span class="line">                    <span class="comment">// 处理被触发的事件</span></span><br><span class="line">                    handles(selectionKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理后清空</span></span><br><span class="line">                selectionKeys.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            close(selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 处理事件 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handles</span><span class="params">(SelectionKey selectionKey)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">// 如果触发了 ACCEPT 事件 —— 和客户端建立了连接</span></span><br><span class="line">        <span class="keyword">if</span> (selectionKey.isAcceptable()) &#123;</span><br><span class="line">            <span class="comment">// 获取客户端的 channel</span></span><br><span class="line">            SocketChannel client = ((ServerSocketChannel)(selectionKey.channel())).accept();</span><br><span class="line">            <span class="comment">// 设为非阻塞调用模式</span></span><br><span class="line">            client.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 注册客户端的 READ 事件到 selector</span></span><br><span class="line">            client.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 触发的是 READ 事件</span></span><br><span class="line">            <span class="comment">// 获取客户端的 channel</span></span><br><span class="line">            SocketChannel client = (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 避免设为 BIO 模式报错，取消注册</span></span><br><span class="line">            selectionKey.cancel();</span><br><span class="line">            <span class="comment">// 由于要使用 BIO，重设为阻塞模式</span></span><br><span class="line">            client.configureBlocking(<span class="keyword">true</span>);</span><br><span class="line">            Socket socket = client.socket();</span><br><span class="line">            <span class="comment">// 客户端输入流</span></span><br><span class="line">            InputStream inputStream = socket.getInputStream();</span><br><span class="line">            <span class="comment">// 客户端输出流</span></span><br><span class="line">            OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">            <span class="comment">// 创建 Request 实例并解析 URI</span></span><br><span class="line">            Request request = <span class="keyword">new</span> Request(inputStream);</span><br><span class="line">            request.parse();</span><br><span class="line">            <span class="comment">// 创建 Response 实例并设置 request</span></span><br><span class="line">            Response response = <span class="keyword">new</span> Response(outputStream);</span><br><span class="line">            response.setRequest(request);</span><br><span class="line">            <span class="comment">// 根据 URI 的开头判断资源类型</span></span><br><span class="line">            <span class="keyword">if</span> (request.getURI().startsWith(<span class="string">"/servlet"</span>)) &#123;</span><br><span class="line">                ServletProcessor servletProcessor = <span class="keyword">new</span> ServletProcessor();</span><br><span class="line">                servletProcessor.process(request, response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                StaticProcessor staticProcessor = <span class="keyword">new</span> StaticProcessor();</span><br><span class="line">                staticProcessor.process(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 处理完后断开连接</span></span><br><span class="line">            close(socket);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeable 要关闭的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                closeable.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><ul>
<li>ServerSocket 服务器端通信套接字<ul>
<li>bind()： 绑定服务器信息。</li>
<li>accept()： 获取客户端连接请求，阻塞调用。</li>
<li>通过 InputStream / OutputStream 进行读写操作，阻塞调用。</li>
<li>close()：释放资源。</li>
</ul>
</li>
<li>Socket 客户端通信套接字<ul>
<li>connect()：发送连接请求，和服务器建立连接。</li>
<li>通过 InputStream / OutputStream 进行读写操作，阻塞调用。</li>
<li>close()：释放资源。</li>
</ul>
</li>
<li>特点<ul>
<li>同步阻塞 IO，每个连接分配一个线程。</li>
<li>适用场景：连接数目少、服务器资源多、开发难度低。</li>
</ul>
</li>
</ul>
<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><ul>
<li>Channel 通道<ul>
<li>可双向操作，既可读也可写。</li>
<li>两种模式，既支持阻塞也支持非阻塞。</li>
<li>ServerSocketChannel  服务器端通道，通过静态方法 <code>open()</code> 获取实例。</li>
<li>SocketChannel 客户端通道，通过静态方法 <code>open()</code> 获取实例。</li>
</ul>
</li>
<li>Buffer 缓冲区<ul>
<li>flip() 写模式转为读模式，可以准备从 buffer 获取数据。</li>
<li>clear() / compact() 读模式转为写模式，可以准备向 buffer 写入数据。</li>
</ul>
</li>
<li>Selector 多路复用器<ul>
<li>轮询监控多条 Channel。</li>
<li>select()：查询每个 Channel 是否有事件到达。</li>
</ul>
</li>
<li>特点<ul>
<li>同步非阻塞 IO，只需要一个线程管理多个连接。</li>
<li>适应场景：连接数目多、连接时间短、开发难度高。</li>
</ul>
</li>
</ul>
<h3 id="AIO"><a href="#AIO" class="headerlink" title="AIO"></a>AIO</h3><ul>
<li>AsynchronousServerSocketChannel 异步服务器端通道，通过静态方法 <code>open()</code> 获取实例。</li>
<li>AsynchronousSocketChannel 异步客户端通道，通过静态方法 <code>open()</code> 获取实例。</li>
<li>AsynchronousChannelGroup 异步通道分组管理器，它可以实现资源共享。创建时需要传入一个ExecutorService，也就是绑定一个线程池，该线程池负责两个任务：处理 IO 事件和触发 CompletionHandler 回调接口。</li>
<li>两种异步调用机制：Future 和 CompletionHandler。</li>
<li>适用场景：连接数目多、连接时间长、开发难度高。</li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/20/5_Mybatis 入门实战笔记/" rel="next" title="Mybatis 入门实战笔记">
                <i class="fa fa-chevron-left"></i> Mybatis 入门实战笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/20/2_SpringMVC 入门实战笔记/" rel="prev" title="SpringMVC 入门实战笔记">
                SpringMVC 入门实战笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/">
            
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="stone">
            
          </a>
              <p class="site-author-name" itemprop="name">stone</p>
              <div class="site-description motion-element" itemprop="description">Hungry Fool</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      


      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">


            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前置概念"><span class="nav-number">1.</span> <span class="nav-text">前置概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-IO-模型"><span class="nav-number">1.1.</span> <span class="nav-text">Java IO 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-内核-IO-模型"><span class="nav-number">1.2.</span> <span class="nav-text">Linux 内核 IO 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URL-解析与构造"><span class="nav-number">1.3.</span> <span class="nav-text">URL 解析与构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网络分层"><span class="nav-number">1.4.</span> <span class="nav-text">网络分层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java-io"><span class="nav-number">1.5.</span> <span class="nav-text">java.io</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Socket-概述"><span class="nav-number">1.6.</span> <span class="nav-text">Socket 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步-异步-阻塞-非阻塞"><span class="nav-number">1.7.</span> <span class="nav-text">同步/异步/阻塞/非阻塞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池"><span class="nav-number">1.8.</span> <span class="nav-text">线程池</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BIO-同步阻塞"><span class="nav-number">2.</span> <span class="nav-text">BIO 同步阻塞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟-TCP-通信"><span class="nav-number">2.1.</span> <span class="nav-text">模拟 TCP 通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于-BIO-的多人聊天室"><span class="nav-number">2.2.</span> <span class="nav-text">基于 BIO 的多人聊天室</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#伪异步-IO-改进多人聊天室"><span class="nav-number">2.3.</span> <span class="nav-text">伪异步 IO 改进多人聊天室</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NIO-同步非阻塞"><span class="nav-number">3.</span> <span class="nav-text">NIO 同步非阻塞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本地文件拷贝"><span class="nav-number">3.1.</span> <span class="nav-text">本地文件拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-NIO-改写多人聊天室"><span class="nav-number">3.2.</span> <span class="nav-text">使用 NIO 改写多人聊天室</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AIO-异步非阻塞"><span class="nav-number">4.</span> <span class="nav-text">AIO 异步非阻塞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#回音聊天室"><span class="nav-number">4.1.</span> <span class="nav-text">回音聊天室</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-AIO-改写多人聊天室"><span class="nav-number">4.2.</span> <span class="nav-text">使用 AIO 改写多人聊天室</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简易-Web-服务器的实现"><span class="nav-number">5.</span> <span class="nav-text">简易 Web 服务器的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#处理静态资源请求"><span class="nav-number">5.1.</span> <span class="nav-text">处理静态资源请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTPStatus-状态码枚举类"><span class="nav-number">5.1.1.</span> <span class="nav-text">HTTPStatus 状态码枚举类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConnectorUtils-工具类"><span class="nav-number">5.1.2.</span> <span class="nav-text">ConnectorUtils 工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-处理请求"><span class="nav-number">5.1.3.</span> <span class="nav-text">Request 处理请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-处理响应"><span class="nav-number">5.1.4.</span> <span class="nav-text">Response 处理响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StaticProcessor-处理静态资源"><span class="nav-number">5.1.5.</span> <span class="nav-text">StaticProcessor 处理静态资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Connector-处理服务器连接、请求、响应"><span class="nav-number">5.1.6.</span> <span class="nav-text">Connector 处理服务器连接、请求、响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BootStrap-服务器启动类"><span class="nav-number">5.1.7.</span> <span class="nav-text">BootStrap 服务器启动类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientTest-客户端测试类"><span class="nav-number">5.1.8.</span> <span class="nav-text">ClientTest 客户端测试类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理动态资源请求"><span class="nav-number">5.2.</span> <span class="nav-text">处理动态资源请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Request-和-Response"><span class="nav-number">5.2.1.</span> <span class="nav-text">修改 Request 和 Response</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServletProcessor-处理动态资源"><span class="nav-number">5.2.2.</span> <span class="nav-text">ServletProcessor 处理动态资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TimeServlet-动态资源"><span class="nav-number">5.2.3.</span> <span class="nav-text">TimeServlet 动态资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Connector-的-run-方法"><span class="nav-number">5.2.4.</span> <span class="nav-text">修改 Connector 的 run 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientTest-客户端测试类-1"><span class="nav-number">5.2.5.</span> <span class="nav-text">ClientTest 客户端测试类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-NIO-改写-Connector"><span class="nav-number">5.3.</span> <span class="nav-text">使用 NIO 改写 Connector</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BIO"><span class="nav-number">6.1.</span> <span class="nav-text">BIO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIO"><span class="nav-number">6.2.</span> <span class="nav-text">NIO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AIO"><span class="nav-number">6.3.</span> <span class="nav-text">AIO</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">stone</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'BfQW4FLTza3lJnrgwNX9oCW1-gzGzoHsz',
    appKey: '0L4jcEeI7bk5hnenGxU9XGk2',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn'
  });
</script>




  


  




  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
<!-- 页面点击核心价值观 -->
<script type="text/javascript" src="/js/src/clickfuqiang.js"></script>
<!-- 点击爆炸 -->

<!-- 音频播放 -->
<link rel="stylesheet" href="/js/src/APlayer.min.css">
  <div id="player" class="aplayer aplayer-withlist aplayer-fixed" data-id="3148759183" data-server="netease" data-type="playlist" data-order="random" data-fixed="true" data-listfolded="true" data-theme="#2D8CF0"></div>
  <script src="/js/src/APlayer.min.js"></script>
  <script src="/js/src/music.js"></script>
<script>
$(".aplayer-play").click()   // 如果想让歌曲在页面加载完播放可以设置
</script>

<!-- 猫 -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/2662419405/CDN/pio.css">
<script src="https://cdn.jsdelivr.net/gh/2662419405/CDN/l2dPlus.js"></script>
<script src="https://cdn.jsdelivr.net/gh/2662419405/CDN/pioPlus.js"></script>
<script src="https://cdn.jsdelivr.net/gh/2662419405/CDN/mao.js"></script>

<!-- mouse-click -->
<script src="/js/src/mouseclick.js" type="text/javascript"></script>
<!-- mouse-follow -->
<span class="js-cursor-container"></span>
<script src="/js/src/mousefollow.js" type="text/javascript"></script>